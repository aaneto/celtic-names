language: rust
cache: cargo
git:
  depth: 1

env:
  global:
    - CRATE_NAME=celtic_names

stages:
  - test
  - code_coverage
  - quality_gate
  - deploy

jobs:
  include:
    - stage: test
      script: cargo test
      os: linux
      rust: nightly
      if: NOT tag =~ /^v\d+\.\d+\.\d+.*$/
    
    - stage: test
      script: cargo test
      os: linux
      rust: stable
      if: NOT tag =~ /^v\d+\.\d+\.\d+.*$/

    - stage: test
      script: cargo test
      os: osx
      rust: stable
      if: NOT tag =~ /^v\d+\.\d+\.\d+.*$/
    
    - stage: code_coverage
      os: linux
      rust: stable
      before_script: cargo install cargo-tarpaulin --force
      script:
        - cargo tarpaulin --out Xml
        - bash <(curl -s https://codecov.io/bash)
      if: tag =~ /^v\d+\.\d+\.\d+.*$/

    - stage: quality_gate
      os: linux
      rust: stable
      before_script:
        - rustup component add rustfmt
        - rustup component add clippy
      script:
        - cargo clippy -- -D warnings
        - cargo fmt --all -- --check

    - stage: prepare_deploy
      script:
        - cargo build --release
        - cargo test --release
        - mv target/release/$CRATE_NAME $TRAVIS_OS_NAME-$CRATE_NAME
      os: osx
      rust: stable
      if: tag =~ /^v\d+\.\d+\.\d+.*$/
    
    - stage: prepare_deploy
      script:
        - cargo build --release
        - cargo test --release
        - mv target/release/$CRATE_NAME $TRAVIS_OS_NAME-$CRATE_NAME
      os: linux
      rust: stable
      if: tag =~ /^v\d+\.\d+\.\d+.*$/

deploy:
  api_key: $GITHUB_DEPLOY_KEY
  file: $TRAVIS_OS_NAME-$CRATE_NAME
  on:
    condition: $TRAVIS_RUST_VERSION = stable
    tags: true
  provider: releases
  skip_cleanup: true
  name: $TRAVIS_TAG

branches:
  only:
    - master
    - /^v\d+\.\d+\.\d+.*$/
